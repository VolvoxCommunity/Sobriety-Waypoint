name: Auto Label with Claude

on:
  pull_request:
    types: [opened, reopened, edited]
  issues:
    types: [opened, reopened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Auto Label with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: false
          use_sticky_comment: false
          prompt: |
            REPO: ${{ github.repository }}
            ${{ github.event.pull_request && format('PR NUMBER: {0}', github.event.pull_request.number) || format('ISSUE NUMBER: {0}', github.event.issue.number) }}
            EVENT TYPE: ${{ github.event.pull_request && 'pull_request' || 'issue' }}

            **Task: Intelligent Auto-Labeling**

            You are an intelligent labeling assistant. Analyze the ${{ github.event.pull_request && 'pull request' || 'issue' }} and apply appropriate labels based on the content, files changed, and description.

            **Available Labels:**
            - `bug` - Something isn't working
            - `documentation` - Improvements or additions to documentation
            - `enhancement` - Enhancement on existing feature
            - `feature` - New feature
            - `dependencies` - Dependency updates
            - `backend` - Backend/API related changes
            - `frontend` - Frontend/UI related changes
            - `security` - Security related issues or improvements
            - `testing` - Testing related changes
            - `accessibility` - Accessibility improvements
            - `performance` - Performance improvements
            - `android` - Android specific issues
            - `ios` - iOS specific issues
            - `web` - Web specific issues
            - `supabase` - Supabase/database related
            - `authentication` - Authentication related issues
            - `ci/cd` - CI/CD pipeline related
            - `refactor` - Code refactoring

            **Available Issue Types (ISSUES ONLY - choose exactly 1):**
            - `Bug` - Something isn't working correctly
            - `Feature` - New functionality or capability
            - `Documentation` - Documentation improvements
            - `Task` - General work item or chore

            **Instructions:**

            1. **Analyze the Content:**
               ${{ github.event.pull_request && '- Read the PR title, description, and changed files using `gh pr view`' || '- Read the issue title and description using `gh issue view`' }}
               ${{ github.event.pull_request && '- Use `gh pr diff` to understand what code is being changed' || '' }}
               - Identify the type of change (bug fix, feature, documentation, task)
               - Determine which areas of the codebase are affected

            2. **Assign Issue Type (ISSUES ONLY - REQUIRED):**
               - Skip this step for pull requests
               - For issues: Choose exactly ONE type that best describes this issue
               - Use: ${{ github.event.issue && format('`gh issue edit {0} --type "TypeName"`', github.event.issue.number) || '(not applicable for PRs)' }}

            3. **Apply Labels:**
               - Select all appropriate labels that apply to this ${{ github.event.pull_request && 'PR' || 'issue' }}
               - Use the `gh` CLI to add labels:
                 ${{ github.event.pull_request && format('`gh pr edit {0} --add-label "label1,label2,label3"`', github.event.pull_request.number) || format('`gh issue edit {0} --add-label "label1,label2,label3"`', github.event.issue.number) }}

            4. **Labeling Guidelines:**
               - **Type Labels**: bug, feature, enhancement, documentation, refactor, testing, dependencies
               - **Area Labels**: frontend, backend, supabase, authentication, ci/cd, android, ios, web
               - **Special Labels**: security, accessibility, performance

            5. **Examples:**
               - Issue reporting login crash → Type: `Bug`, Labels: `bug`, `authentication`, `frontend`
               - Issue requesting new feature → Type: `Feature`, Labels: `feature`, `frontend`
               - Issue requesting docs update → Type: `Documentation`, Labels: `documentation`
               - Issue for general work → Type: `Task`, Labels: `enhancement`, `backend`
               - PR adding new authentication flow → Labels: `feature`, `authentication`, `frontend`
               - PR updating dependencies → Labels: `dependencies`
               - PR improving accessibility → Labels: `enhancement`, `accessibility`, `frontend`
               - PR refactoring database queries → Labels: `refactor`, `supabase`, `backend`

            **Important:**
            - Do NOT create new labels; only use the labels listed above
            - For ISSUES: ALWAYS assign a type - this is required
            - For PRs: Do NOT try to assign a type (types are for issues only)
            - Be conservative with labels: only add labels that clearly apply
            - For PRs, prioritize file changes over description
            - For issues, prioritize the problem description and impact

            **Execute the labeling (and type assignment if this is an issue) now using the gh CLI.**

          claude_args: '--allowed-tools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr edit:*),Bash(gh issue view:*),Bash(gh issue edit:*),Bash(gh issue type:*)"'
